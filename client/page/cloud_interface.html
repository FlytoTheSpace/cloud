<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Drive</title>
    <script src="/templates/js/default.js" defer></script>
    <link rel="stylesheet" href="/templates/css/theme/dark.css" id="themeStyleSheet">
    <link rel="stylesheet" href="/css/cloud.css">

    <script>
        const themeStyleSheet = document.getElementById('themeStyleSheet')
        const theme = {
            main: "dark",
            icon: "color"
        }
        themeStyleSheet.href = `/templates/css/theme/${theme.main}.css`
    </script>
    <script src="/js/cloud_sidebar.js" defer></script>
    <script>
        const $ = (query, multiple) => multiple ? document.querySelectorAll(query) : document.querySelector(query);

        function getUserID() {
            let userId;
            if (structuredClone(location.href).endsWith('u') || structuredClone(location.href).endsWith('u/')) {
                userId = 'u'
            } else if (location.href.includes('shared' || 'shared/')) {

            }
            return userId
        }
        async function loadFiles(path) {
            const filesSection = $('#filesection', false)
            filesSection.innerHTML = ''
            const userId = getUserID()
            const options = {
                method: 'GET',
                headers: {
                    path: path
                }
            }
            const request = await fetch(`/cloud/files/${userId}`, options)
            if (!request.ok) { return alert("Unable to Load Files") }
            $('#directoryInputBar').value = path
            $('#directoryInputBar').dataset.path = path

            const ReponseObject = await request.json()

            if (ReponseObject.length < 1) {
                filesSection.innerHTML = 'No Files Found'
                return null;
            }

            ReponseObject.forEach(fileObject => {

                const filename = fileObject.name;
                const filepath = fileObject.path;
                const type = fileObject.type;

                filesection.insertAdjacentHTML('beforeend', `
                
                <div class="file" data-path="${filepath}" data-type="${type}" data-name="${filename}" data-selected='false' data-timeout="false">
                    <div class="icon">
                        <img src="${(type !== 'directory') ? '/assets/images/icons/file/txt.png' : '/assets/images/icons/light/folder.svg'}" alt="">
                    </div>
                    <div class="name">${filename.length > 40? filename.slice(0, 49)+'..': filename}</div>
                </div>`

                )
            })
            const fileElements = $('.file', true)
            Array.from(fileElements).forEach(fileElement => {
                fileElement.addEventListener('click', (event) => {
                    const file = event.target.closest('.file')
                    if (file.dataset.selected === 'true' && file.dataset.timeout === 'true') {
                        // On Double Click on Files/Directory
                        file.dataset.timeout === false
                        open(file.dataset)
                    }
                    // On Single Click
                    else if (file.dataset.selected === 'false') {
                        file.dataset.selected = true
                        file.style.background = 'rgba(91, 115, 183, 0.66)'

                        file.dataset.timeout = true;
                        setTimeout(() => {
                            file.dataset.timeout = false;
                        }, 1 * 1000);
                    } else {
                        file.dataset.selected = false
                        file.style.background = 'var(--bold-background)'
                    }
                })
            })
        }
        async function open(dataset) {
            if (dataset.type === 'directory') {
                loadFiles(dataset.path)
            } else if (dataset.type === 'file') {
                const userId = getUserID()

                const options = {
                    method: 'GET',
                    headers: {
                        path: dataset.path,
                        action: 'open'
                    }
                }

                const request = await fetch(`/cloud/files/actions/${userId}`, options)
                if (!request.ok) { return alert("Unable to Open The File") }

                const File = await request.blob()

                const fileURL = URL.createObjectURL(File)
                preview(fileURL)
            }
        }
        async function download(dataset) {
            if (dataset.type !== 'file') { return alert("You can only Downloads Files") }
            const userId = getUserID()

            const options = {
                method: 'GET',
                headers: {
                    path: dataset.path,
                    action: 'open'
                }
            }

            const request = await fetch(`/cloud/files/actions/${userId}`, options)
            if (!request.ok) { return alert("Unable to Download The Files") }

            const File = await request.blob()

            const fileURL = URL.createObjectURL(File)

            const link = document.createElement('a');
            link.href = fileURL;
            document.body.appendChild(link)
            link.download = dataset.name

            link.click()
            document.body.removeChild(link)
        }
        async function deletes(dataset) {
            const userId = getUserID()

            const options = {
                method: 'GET',
                headers: {
                    path: dataset.path,
                    type: dataset.type,
                    action: 'delete'
                }
            }

            const request = await fetch(`/cloud/files/actions/${userId}`, options)
            if (!request.ok) { return alert("Unable to Load The Files") }

            const File = await request.json()

            loadFiles($('#directoryInputBar').dataset.path)
        }
    </script>

    <style>
        #mainContainer {
            display: flex;
            flex-direction: column;
        }

        /* Navigation Bar */
        #mainSectionTopBar {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            border-top-right-radius: inherit;
            border-top-left-radius: inherit;
            width: calc(100% - 20px);
        }

        #optionsbar {
            padding: 0 10px;
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        #dirBar {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #mainSectionTopBar .actionBtn {
            margin: 5px;
            height: 50px;
            width: 50px;
            color: white;
        }

        #mainSectionTopBar * img {
            width: 50px;
            height: 50px;
        }

        /* Main Section */
        #filesection {
            overflow-y: scroll;
            padding: 40px;
            display: flex;
            flex-wrap: wrap;
        }

        .file {
            margin: 0 10px;
            background: var(--bold-background);
            padding: 10px 10px;
            min-height: 150px;
            width: 100px;
            border-radius: 10px;
        }

        .file .icon {
            height: 115px;
        }

        .file .icon img {
            height: 100px;
            width: 100px;
        }

        .file .name {
            width: 100px;
            text-align: center;
            height: calc(10% + 20px);
            overflow-wrap: break-word;
        }

        .file .icon img {
            max-height: 100%;
            max-width: 100%;
        }
    </style>

    <style>
        #previewWindow {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.363);
            position: fixed;
            z-index: 10;
            top: 0;
            left: 0;
            display: none;
        }

        #previewContainerNavbar {
            padding: 0 10px;
            width: calc(100% - 20px);
            height: 70px;
            background: var(--navbar);
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        #previewSection {
            width: 100%;
            height: calc(100% - 70px);
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--main-background);
        }

        #preview {
            width: 100%;
            height: 100%;
        }
    </style>
    
    <style>
        #uploadWindowBackground {
            width: 100%;
            height: 100%;
            background: rgba(88, 88, 88, 0.363);
            position: fixed;
            z-index: 10;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #uploadWindow {
            padding: 10px 10px;
            width: 70%;
            height: 70%;
            background: var(--navbar);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #uploadForm {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #uploadInputLabel{
            background-image: url("/assets/images/icons/light/upload.svg");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50% 50%;
            margin: 20px 20px;
            height: calc(100% - 40px);
            width: calc(100% - 40px);
            border: 1px solid gray;
            border-radius: 20px;
            display: flex;
            font-size: 20px;
            justify-content: center;
            align-items: flex-end;
            text-align: center;
        }

        #uploadInput {
            display: none;
        }

        @media screen and (max-width: 500px) {
            #uploadWindow{
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="previewWindow">
        <div id="previewContainerNavbar">
            <button class="circle c-transparent withIcon" id="previewCloseButton"><img
                    src="/assets/images/icons/light/close.svg" alt=""></button>
        </div>
        <div id="previewSection">
            <iframe src="" frameborder="1" id="preview"></iframe>
        </div>
    </div>
    <div id="uploadWindowBackground">
        <div id="uploadWindow">
            <p>Select or Drang and Drop Files here!</p>
            <form action="/cloud/files/" id="uploadForm" enctype="multipart/form-data">
                <label for="uploadInput" id="uploadInputLabel"></label>
                <input type="file" name="file" id="uploadInput" multiple>
            </form>
            <div id="bottombar">
                <button class="t-1 c-blue withIcon" id="uploadBtn"><img src="/assets/images/icons/light/upload.svg" alt="">Upload</button>
                <button class="t-2 c-blue withIcon" id="uploadCancel"><img src="/assets/images/icons/light/close.svg" alt="">Cancel</button>
            </div>
        </div>
    </div>
    <header></header>
    <main>
        <div id="sidebar">
            <ul></ul>
        </div>
        <div id="mainContainer">
            <div id="mainSectionTopBar">
                <div id="optionsbar">
                    <button class="t-1 c-blue withIcon" id="uploadWindowOpenBtn"><img src="/assets/images/icons/light/upload.svg" alt="">Upload</button>
                    <button class="circle c-transparent withIcon actionBtn" id="open"><img src="/assets/images/icons/light/file_open.svg" alt=""></button>
                    <button class="circle c-transparent withIcon actionBtn" id="download"><img src="/assets/images/icons/light/download.svg" alt=""></button>
                    <button class="circle c-transparent withIcon actionBtn" id="copy"><img src="/assets/images/icons/light/copy.svg" alt=""></button>
                    <button class="circle c-transparent withIcon actionBtn" id="paste"><img src="/assets/images/icons/light/paste.svg" alt=""></button>
                    <button class="circle c-transparent withIcon actionBtn" id="delete"><img src="/assets/images/icons/light/delete.svg" alt=""></button>
                </div>
                <div id="dirBar">
                    <input type="text" id="directoryInputBar" value="/" data-path="/">
                </div>
            </div>
            <hr>
            <div id="filesection"></div>
        </div>
    </main>
    <footer></footer>
    <script>
        loadFiles('/')
        
        const uploadBtn = $('#uploadBtn')
        const uploadOpenWindowBtn = $('#uploadWindowOpenBtn')
        const uploadWindowBackground = $('#uploadWindowBackground')
        
        uploadBtn.addEventListener('click', async ()=>{
            
            console.log("Submitting....")

            const files = $('#uploadInput').files[0]
            const FormData = new FormData()
            const userID = getUserID()

            FormData.append(files)
            
            const headers = {
                'path': $('#directoryInputBar').dataset.path,
                'CustomHeader': 'CustomValue'
            };
            
            // Fetch API
            const UploadRequest = await fetch(`/cloud/files/upload/${userID}`, {
                method: 'POST',
                headers: headers,
                body: formData
            })

            const UploadReponse = await UploadRequest.json();

            console.log({Meta: UploadRequest})
            console.log({Reponse: UploadRequest})

        })

        uploadOpenWindowBtn.addEventListener('click', ()=>{
            // Uploading
            uploadWindowBackground.style.display = 'flex'
        })

        $('#uploadCancel').addEventListener('click', ()=>{
            // Cancelling Upload
            $('#uploadWindowBackground').style.display = 'none'
            $('#uploadInput').value = ''
            $('#uploadInputLabel').textContent = 'Choose files';
        })
        
        $('#uploadInput').addEventListener('change', function() {
            const files = this.files;
            const uploadInputLabel = $('#uploadInputLabel');

            if (files.length <= 0){
                return uploadInputLabel.textContent = 'Choose files';
            }
            const fileNames = `Selected ${Array.from(files).map(file => file.name).join(', ')}`;
            uploadInputLabel.textContent = fileNames;
        });


        function preview(fileURL) {
            const previewWindow = $('#previewWindow');
            const previewElement = $('#preview');
            const previewCloseButton = $('#previewCloseButton');

            previewWindow.style.display = 'block';
            previewElement.src = fileURL;

            previewElement.addEventListener('load', () => {

                const iframeDOM = previewElement.contentDocument;

                if (theme.main === 'dark') { iframeDOM.body.style.color = 'white' }
                try {
                    if (iframeDOM.body.firstElementChild.tagName.toLowerCase() === 'img') {
                        iframeDOM.body.firstElementChild.classList.remove('shrinkToFit')
                        iframeDOM.body.firstElementChild.style.margin = '0 auto'
                    }
                } catch (error) { }
            })
            previewCloseButton.onclick = () => {
                URL.revokeObjectURL(fileURL);
                previewElement.src = '';
                previewWindow.style.display = 'none';
            }

        }
        const actionBtns = Array.from($('.actionBtn', true))
        window.addEventListener('keydown', (event) => {
            const fileElements = Array.from($("#filesection > .file[data-selected='true']", true))
            if (fileElements.length < 1) { return null }

            if (event.key === 'Delete') {
                // Deleting Every one of them
                fileElements.forEach((fileElement) => {
                    deletes(fileElement.dataset);
                })
            }
        })
        actionBtns.forEach(actionBtn => {
            actionBtn.addEventListener('click', ({ target }) => {
                const btn = target.closest('.actionBtn')

                // Every Selected Element
                const fileElements = Array.from($("#filesection > .file[data-selected='true']", true))
                if (fileElements.length < 1) { return null }

                if (btn.id === 'open') {
                    // Opening File/Directory
                    open(fileElements[0].dataset)
                } else if (btn.id === 'download') {
                    // Download Every one of them
                    fileElements.forEach((fileElement) => {
                        console.log("Download is Triggered")
                        download(fileElement.dataset);
                    })
                } else if (btn.id === 'delete') {
                    // Deleting Every one of them
                    fileElements.forEach((fileElement) => {
                        console.log("delete is Triggered")
                        deletes(fileElement.dataset);
                    })
                }
            })
        })
        const directoryInputBar = $('#directoryInputBar')
        directoryInputBar.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                loadFiles(event.target.value)
            }
        })
    </script>
</body>

</html>